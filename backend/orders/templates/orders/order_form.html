{% extends "base.html" %}
{% block title %}{% if order %}Edit Order{% else %}Create Order{% endif %}{% endblock %}
{% block content %}
<h3 class="mb-3">{% if order %}Edit Order{% else %}Create Order{% endif %}</h3>
<form method="post" class="card shadow-sm">
  {% csrf_token %}
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Customer</label>
        <select class="form-select" name="customer" id="customer-select" required>
          <option value="">Select customer</option>
          {% for c in customers %}<option value="{{ c.id }}" {% if order.customer.id == c.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Branch</label>
        <select class="form-select" name="branch" id="branch-select">
          {% if order and order.branch %}<option value="{{ order.branch.id }}" selected>{{ order.branch.name }}</option>{% else %}<option value="">--</option>{% endif %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input class="form-control" type="date" name="date" value="{{ order.date|date:'Y-m-d' }}" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Remarks</label>
        <input class="form-control" type="text" name="remarks" value="{{ order.remarks|default:'' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Logistics Provider</label>
        <input class="form-control" type="text" name="logistics_provider" value="{{ order.logistics_provider|default:'' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Logistics Cost</label>
        <input class="form-control" type="number" step="0.01" name="logistics_cost" value="{{ order.logistics_cost|default:'' }}">
      </div>
    </div>
    <hr class="my-4">
    <h5 class="mb-3">Items</h5>
    <div class="table-responsive">
      <table class="table align-middle" id="items-table">
        <thead>
          <tr><th style="width:28%">Product</th><th>Length</th><th>Boxes</th><th>Stems/Box</th><th>Price/Stem</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="btn btn-outline-primary btn-sm" type="button" onclick="addRow()">Add Item</button>
  </div>
  <div class="card-footer text-end">
    <button class="btn btn-primary">Save</button>
    <a class="btn btn-outline-secondary" href="{% if order %}{% url 'orders:order_detail' order.id %}{% else %}{% url 'orders:order_list' %}{% endif %}">Cancel</a>
  </div>
</form>

<script>
function addRow() {
  const tbody = document.querySelector('#items-table tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>
      <select class="form-select form-select-sm item-product" name="item_product">
        <option value="">Select</option>
        {% for p in products %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}
      </select>
    </td>
    <td><input class="form-control form-control-sm item-stem" type="number" name="item_stem_length_cm" placeholder="cm"></td>
    <td><input class="form-control form-control-sm" type="number" name="item_boxes" value="1" min="1"></td>
    <td><input class="form-control form-control-sm" type="number" name="item_stems_per_box" value="1" min="1"></td>
    <td><input class="form-control form-control-sm item-price" type="number" step="0.01" name="item_price_per_stem" placeholder="0.00"></td>
    <td class="text-end"><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()">Remove</button></td>
  `;
  tbody.appendChild(row);

  // Add event listener for product selection
  const productSelect = row.querySelector('.item-product');
  productSelect.addEventListener('change', function() {
    const pid = this.value; if(!pid) return;
    const customerId = document.getElementById('customer-select').value;
    const form = new FormData(); form.append('customer_id', customerId); form.append('product_id', pid);
    fetch('/orders/get-defaults/', { method: 'POST', body: form })
      .then(r => r.json()).then(d => {
        if (d.success) {
          if (d.stem_length_cm) row.querySelector('.item-stem').value = d.stem_length_cm;
          if (d.price_per_stem) row.querySelector('.item-price').value = d.price_per_stem;
        }
      });
  });

  return row;
}

// Initialize the form
document.addEventListener('DOMContentLoaded', function() {
    {% if order and order.items.count > 0 %}
        // Editing existing order with items - load existing items
        {% for item in order.items.all %}
        const row = addRow();
        // Ensure the row is properly created before setting values
        if (row) {
            const productSelect = row.querySelector('.item-product');
            const stemInput = row.querySelector('.item-stem');
            const boxesInput = row.querySelector('input[name="item_boxes"]');
            const stemsPerBoxInput = row.querySelector('input[name="item_stems_per_box"]');
            const priceInput = row.querySelector('.item-price');
            
            if (productSelect) productSelect.value = '{{ item.product.id }}';
            if (stemInput) stemInput.value = '{{ item.stem_length_cm }}';
            if (boxesInput) boxesInput.value = '{{ item.boxes }}';
            if (stemsPerBoxInput) stemsPerBoxInput.value = '{{ item.stems_per_box }}';
            if (priceInput) priceInput.value = '{{ item.price_per_stem }}';
        }
        {% endfor %}
    {% else %}
        // Creating new order or editing order without items - start with one empty row
        addRow();
    {% endif %}
});

document.getElementById('customer-select').addEventListener('change', function(){
  const id = this.value; if(!id) return;
  fetch(`/orders/get-branches/?customer_id=${id}`).then(r=>r.json()).then(list=>{
    const sel = document.getElementById('branch-select'); sel.innerHTML = '<option value="">--</option>';
    list.forEach(b=>{ const o = document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); });
  });
});
</script>
{% endblock %}


