{% extends 'base.html' %}

{% block title %}Dashboard Graphs - Zahara ERP{% endblock %}

{% block content %}
<!-- Graphs Header -->
<div class="dashboard-header">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h1>Dashboard Analytics</h1>
      <p>Interactive charts and data visualization for your business insights.</p>
    </div>
    <div class="col-md-4 text-end">
      <div class="view-buttons">
        <a href="{% url 'home' %}" class="view-btn">
          <i class="bi bi-house me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
  <div class="col-12">
    <div class="data-card">
      <h5 class="card-title">Filter Options</h5>
      <form method="get" action=".">
        <div class="row align-items-end">
          <div class="col-md-3 mb-2">
            <label class="form-label">Date Range</label>
            <div class="input-group">
                <input type="date" class="form-control" name="date_start" value="{{ filters.date_start|default:'' }}" placeholder="Start">
                <span class="input-group-text">-</span>
                <input type="date" class="form-control" name="date_end" value="{{ filters.date_end|default:'' }}" placeholder="End">
            </div>
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">Customer</label>
            <select name="customer" class="form-select">
              <option value="">All Customers</option>
              {% for customer in customers %}
              <option value="{{ customer.id }}" {% if filters.customer == customer.id %}selected{% endif %}>{{ customer.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">Product</label>
            <select name="product" class="form-select">
              <option value="">All Products</option>
              {% for product in products %}
              <option value="{{ product.id }}" {% if filters.product == product.id %}selected{% endif %}>{{ product.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 mb-2">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-filter me-2"></i>Apply Filters
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
  <!-- Top Products Chart -->
  <div class="col-md-6 mb-4">
    <div class="data-card">
      <h5 class="card-title">Top Products by Orders</h5>
      <div class="chart-container">
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Customer Orders Chart -->
  <div class="col-md-6 mb-4">
    <div class="data-card">
      <h5 class="card-title">Customer Orders Distribution</h5>
      <div class="chart-container">
        <canvas id="customerOrdersChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
  <!-- Monthly Revenue Chart -->
  <div class="col-md-8 mb-4">
    <div class="data-card">
      <h5 class="card-title">Monthly Revenue Trend</h5>
      <div class="chart-container">
        <canvas id="monthlyRevenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Expense Categories Chart -->
  <div class="col-md-4 mb-4">
    <div class="data-card">
      <h5 class="card-title">Expense Categories</h5>
      <div class="chart-container">
        <canvas id="expenseCategoriesChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Quick Stats Row -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="metric-card">
      <div class="metric-value">{{ customers.count }}</div>
      <div class="metric-label">Total Customers</div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="metric-card">
      <div class="metric-value">{{ products.count }}</div>
      <div class="metric-label">Total Products</div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="metric-card">
      <div class="metric-value">{{ top_products|length }}</div>
      <div class="metric-label">Top Products</div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="metric-card">
      <div class="metric-value">{{ expense_categories|length }}</div>
      <div class="metric-label">Expense Categories</div>
    </div>
  </div>
</div>


<!-- Toggle Button -->
<div class="row mb-4">
  <div class="col-12 text-center">
    <button class="btn btn-outline-secondary" onclick="toggleAdvancedAnalytics()">
      <i class="bi bi-chevron-down me-2" id="toggleIcon"></i>
      <span id="toggleText">Show Advanced Analytics</span>
    </button>
  </div>
</div>

<!-- Advanced Analytics Section (Hidden by default) -->
<div id="advanced-analytics" style="display: none;">
  <h4 class="mb-4 text-muted border-bottom pb-2">Advanced Insights</h4>
  
  <!-- Row 1: Mix & Daily -->
  <div class="row mb-4">
    <div class="col-md-6 mb-4">
      <div class="data-card">
        <h5 class="card-title">Customer-Product Mix (Top 10)</h5>
        <div class="chart-container">
          <canvas id="cpMixChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="data-card">
        <h5 class="card-title">Daily Sales Trend</h5>
        <div class="chart-container">
          <canvas id="dailySalesChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Status & Payment -->
  <div class="row mb-4">
    <div class="col-md-4 mb-4">
      <div class="data-card">
        <h5 class="card-title">Order Status Distribution</h5>
        <div class="chart-container">
          <canvas id="statusDistChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="data-card">
        <h5 class="card-title">Payment Methods</h5>
        <div class="chart-container">
          <canvas id="payMethodsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="data-card">
        <h5 class="card-title">Stem Length Popularity</h5>
        <div class="chart-container">
          <canvas id="stemLengthsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: AOV -->
  <div class="row mb-4">
    <div class="col-12 mb-4">
      <div class="data-card">
        <h5 class="card-title">Average Order Value (Monthly)</h5>
        <div class="chart-container">
          <canvas id="aovChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Chart container styles */
.chart-container {
  position: relative;
  height: 300px;
  margin: 20px 0;
}

/* Graph toggle button styles */
.view-btn {
  display: inline-block;
  padding: 10px 20px;
  background-color: var(--accent-magenta);
  color: white;
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.view-btn:hover {
  background-color: #8b2d8b;
  color: white;
  text-decoration: none;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 45, 139, 0.3);
}

/* Metric card styles */
.metric-card {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: transform 0.2s ease;
}

.metric-card:hover {
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-magenta);
  margin-bottom: 0.5rem;
}

.metric-label {
  color: #6c757d;
  font-size: 0.9rem;
  font-weight: 500;
}
</style>

<!-- Chart.js and Datalabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
// Register the plugin
Chart.register(ChartDataLabels);

// Global chart instances
let topProductsChart = null;
let customerOrdersChart = null;
let monthlyRevenueChart = null;
let expenseCategoriesChart = null;
    
// Advanced instances
let cpMixChart = null;
let dailySalesChart = null;
let statusDistChart = null;
let payMethodsChart = null;
let stemLengthsChart = null;
let aovChart = null;

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeCharts();
  
  // Render advanced charts too but they are hidden
  initializeAdvancedCharts();
});

// Toggle Advanced Analytics
function toggleAdvancedAnalytics() {
    const section = document.getElementById('advanced-analytics');
    const icon = document.getElementById('toggleIcon');
    const text = document.getElementById('toggleText');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
        text.innerText = 'Hide Advanced Analytics';
    } else {
        section.style.display = 'none';
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
        text.innerText = 'Show Advanced Analytics';
    }
}

// Initialize all charts
function initializeCharts() {
  createTopProductsChart();
  createCustomerOrdersChart();
  createMonthlyRevenueChart();
  createExpenseCategoriesChart();
}

function initializeAdvancedCharts() {
    createCpMixChart();
    createDailySalesChart();
    createStatusDistChart();
    createPayMethodsChart();
    createStemLengthsChart();
    createAovChart();
}

// Common Chart Options
const commonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    datalabels: {
      color: '#fff',
      textShadowColor: 'black',
      textShadowBlur: 4,
      font: {
        weight: 'bold',
        size: 11
      },
      display: 'auto', // Only show if enough space
      formatter: (value, ctx) => {
        // Format if needed
        return value; 
      }
    }
  }
};

// Top Products Chart
function createTopProductsChart() {
  const ctx = document.getElementById('topProductsChart').getContext('2d');
  const topProductsData = {{ top_products|safe }};

  if (!topProductsData || topProductsData.length === 0) {
    showNoData(ctx);
    return;
  }

  const labels = topProductsData.map(p => p.product__name || 'Unknown Product');
  const data = topProductsData.map(p => p.order_count);

  const chartData = {
    labels: labels,
    datasets: [{
      label: 'Orders',
      data: data,
      backgroundColor: [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'
      ],
      borderWidth: 1
    }]
  };

  if (topProductsChart) topProductsChart.destroy();

  topProductsChart = new Chart(ctx, {
    type: 'doughnut',
    data: chartData,
    options: {
      ...commonOptions,
      plugins: {
        ...commonOptions.plugins,
        legend: { position: 'bottom' },
        datalabels: {
            ...commonOptions.plugins.datalabels,
            color: '#000', // Better contrast on light bg if outside, but donut usually inside
            textShadowBlur: 0,
            color: ['#fff', '#fff', '#000', '#fff', '#fff'], // Manually adjust or keep simple
            formatter: (value) => value
        }
      }
    }
  });
}

// Customer Orders Chart
function createCustomerOrdersChart() {
  const ctx = document.getElementById('customerOrdersChart').getContext('2d');
  const customerOrdersData = {{ customer_orders|safe }};

  if (!customerOrdersData || customerOrdersData.length === 0) {
    showNoData(ctx);
    return;
  }

  const labels = customerOrdersData.map(c => c.customer__name || 'Unknown Customer');
  const data = customerOrdersData.map(c => c.order_count);

  const chartData = {
    labels: labels,
    datasets: [{
      label: 'Orders',
      data: data,
      backgroundColor: 'rgba(75, 192, 192, 0.7)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 1
    }]
  };

  if (customerOrdersChart) customerOrdersChart.destroy();

  customerOrdersChart = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      ...commonOptions,
      indexAxis: 'y', // Horizontal Layout for better label fit
      plugins: {
        legend: { display: false },
        datalabels: {
            anchor: 'end',
            align: 'end',
            color: '#666',
            textShadowBlur: 0
        }
      },
      scales: { x: { beginAtZero: true } }
    }
  });
}

// Monthly Revenue Chart
function createMonthlyRevenueChart() {
  const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
  const monthlyLabels = {{ monthly_labels|safe }};
  const monthlyRevenue = {{ monthly_revenue|safe }};

  if (!monthlyRevenue || monthlyRevenue.length === 0) {
    showNoData(ctx);
    return;
  }

  const chartData = {
    labels: monthlyLabels,
    datasets: [{
      label: 'Revenue (KES)',
      data: monthlyRevenue,
      borderColor: 'rgba(255, 99, 132, 1)',
      backgroundColor: 'rgba(255, 99, 132, 0.1)',
      borderWidth: 2,
      fill: true,
      tension: 0.3
    }]
  };

  if (monthlyRevenueChart) monthlyRevenueChart.destroy();

  monthlyRevenueChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      ...commonOptions,
      plugins: {
        legend: { display: false },
        datalabels: {
            display: 'auto',
            align: 'top',
            anchor: 'end',
            color: '#d63031',
            textShadowBlur: 0,
            formatter: (value) => value >= 1000 ? (value/1000).toFixed(1) + 'k' : value
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grace: '10%', // Add 10% padding at top
          ticks: { callback: (val) => 'KES ' + (val/1000) + 'K' }
        }
      }
    }
  });
}

// Expense Categories Chart
function createExpenseCategoriesChart() {
  const ctx = document.getElementById('expenseCategoriesChart').getContext('2d');
  const expenseCategoriesData = {{ expense_categories|safe }};

  if (!expenseCategoriesData || expenseCategoriesData.length === 0) {
    showNoData(ctx);
    return;
  }

  const labels = expenseCategoriesData.map(e => e.category__name || 'Uncategorized');
  const data = expenseCategoriesData.map(e => parseFloat(e.total));

  const chartData = {
    labels: labels,
    datasets: [{
      label: 'Amount (KES)',
      data: data,
      backgroundColor: [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'
      ],
      borderWidth: 1
    }]
  };

  if (expenseCategoriesChart) expenseCategoriesChart.destroy();

  expenseCategoriesChart = new Chart(ctx, {
    type: 'pie',
    data: chartData,
    options: {
      ...commonOptions,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
            color: '#fff',
            formatter: (value, ctx) => {
                let sum = 0;
                let dataArr = ctx.chart.data.datasets[0].data;
                dataArr.map(data => { sum += data; });
                return (value*100 / sum).toFixed(0)+"%";
            }
        }
      }
    }
  });
}

// --- Advanced Charts Implementations ---

// 1. Customer-Product Mix (Stacked Bar)
function createCpMixChart() {
    const ctx = document.getElementById('cpMixChart').getContext('2d');
    const data = {{ cp_mix|safe }};
    
    if (!data || !data.labels || data.labels.length === 0) { showNoData(ctx); return; }
    
    // Assign colors to datasets automatically
    const colors = ['#36a2eb', '#ff6384', '#ffce56', '#4bc0c0', '#9966ff'];
    data.datasets.forEach((ds, i) => {
        ds.backgroundColor = colors[i % colors.length];
        ds.stack = 'stack0';
    });

    if (cpMixChart) cpMixChart.destroy();
    
    cpMixChart = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            ...commonOptions,
            scales: { x: { stacked: true }, y: { stacked: true } },
            plugins: {
                datalabels: { display: false } // Too crowded for stacked
            }
        }
    }); 
}

// 2. Daily Sales (Line)
function createDailySalesChart() {
    const ctx = document.getElementById('dailySalesChart').getContext('2d');
    const data = {{ daily_sales|safe }};
    
    if (!data || !data.data || data.data.length === 0 || data.data.every(v => v === 0)) { showNoData(ctx); return; }

    if (dailySalesChart) dailySalesChart.destroy();
    
    dailySalesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Revenue',
                data: data.data,
                borderColor: '#00b894',
                backgroundColor: 'rgba(0, 184, 148, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { display: false },
                datalabels: { display: false } // Too dense for daily
            }
        }
    });
}

// 3. Status Distribution (Pie)
function createStatusDistChart() {
    const ctx = document.getElementById('statusDistChart').getContext('2d');
    const data = {{ status_dist|safe }};
    
    // Check if any data
    if (!data || !data.data.some(v => v > 0)) { showNoData(ctx); return; }

    if (statusDistChart) statusDistChart.destroy();
    
    statusDistChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c', '#95a5a6']
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { position: 'right' },
                datalabels: {
                    color: '#fff',
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.map(data => { sum += data; });
                        return value > 0 ? (value*100 / sum).toFixed(0)+"%" : '';
                    }
                }
            }
        }
    });
}

// 4. Payment Methods (Doughnut)
function createPayMethodsChart() {
    const ctx = document.getElementById('payMethodsChart').getContext('2d');
    const data = {{ pay_methods|safe }};
    
    if (!data || !data.data.some(v => v > 0)) { showNoData(ctx); return; }

    if (payMethodsChart) payMethodsChart.destroy();
    
    payMethodsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: ['#0984e3', '#6c5ce7', '#fdcb6e', '#e17055', '#00cec9']
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { position: 'bottom' },
                datalabels: { color: '#fff' }
            }
        }
    });
}

// 5. Stem Lengths (Bar)
function createStemLengthsChart() {
    const ctx = document.getElementById('stemLengthsChart').getContext('2d');
    const data = {{ stem_lengths|safe }};
    
    if (!data || !data.data.some(v => v > 0)) { showNoData(ctx); return; }

    if (stemLengthsChart) stemLengthsChart.destroy();
    
    stemLengthsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Quantity',
                data: data.data,
                backgroundColor: '#fd79a8'
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#636e72',
                    textShadowBlur: 0
                }
            }
        }
    });
}

// 6. AOV Chart (Line)
function createAovChart() {
    const ctx = document.getElementById('aovChart').getContext('2d');
    const labels = {{ monthly_labels|safe }}; // Reuse monthly labels
    const data = {{ aov_data|safe }};
    
    if (!data || data.every(v => v === 0)) { showNoData(ctx); return; }

    if (aovChart) aovChart.destroy();
    
    aovChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Avg Order Value',
                data: data,
                borderColor: '#e84393',
                backgroundColor: 'rgba(232, 67, 147, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: (val) => (val/1000).toFixed(1) + 'K' }
                }
            }
        }
    });
}

function showNoData(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = '#999';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
}
</script>
{% endblock %}
