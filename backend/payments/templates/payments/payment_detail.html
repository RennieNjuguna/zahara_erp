{% extends "base.html" %}
{% block title %}Payment {{ payment.payment_id|truncatechars:8 }} | Zahara ERP{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-credit-card me-2"></i>Payment Details
                    </h2>
                    <p class="text-muted mb-0">Payment ID: {{ payment.payment_id|truncatechars:8 }}</p>
                </div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'payments:dashboard' %}">Payments</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'payments:payment_list' %}">All Payments</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Details</li>
                    </ol>
                </nav>
            </div>

            <!-- Payment Details and Allocations -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-info-circle me-2"></i>Payment Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Customer</dt>
                                <dd class="col-sm-8">{{ payment.customer.name }}</dd>
                                <dt class="col-sm-4">Amount</dt>
                                <dd class="col-sm-8">
                                    <span class="fw-bold fs-5">{{ payment.amount }} {{ payment.currency }}</span>
                                </dd>
                                <dt class="col-sm-4">Method</dt>
                                <dd class="col-sm-8">{{ payment.get_payment_method_display }}</dd>
                                <dt class="col-sm-4">Date</dt>
                                <dd class="col-sm-8">{{ payment.payment_date|date:"M d, Y" }}</dd>
                                <dt class="col-sm-4">Status</dt>
                                <dd class="col-sm-8">
                                    {% if payment.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif payment.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif payment.status == 'cancelled' %}
                                        <span class="badge bg-danger">Cancelled</span>
                                    {% elif payment.status == 'refunded' %}
                                        <span class="badge bg-info">Refunded</span>
                                    {% endif %}
                                </dd>
                                <dt class="col-sm-4">Reference</dt>
                                <dd class="col-sm-8">{{ payment.reference_number|default:"-" }}</dd>
                                <dt class="col-sm-4">Unallocated</dt>
                                <dd class="col-sm-8">
                                    <span class="fw-bold {% if payment.unallocated_amount > 0 %}text-warning{% else %}text-success{% endif %}">
                                        {{ payment.unallocated_amount }} {{ payment.currency }}
                                    </span>
                                </dd>
                            </dl>
                            <div class="mt-3">
                                <a class="btn btn-outline-secondary btn-sm" href="{% url 'payments:payment_edit' payment.payment_id %}">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </a>
                                <a class="btn btn-outline-primary btn-sm" href="{% url 'payments:payment_list' %}">
                                    <i class="bi bi-arrow-left me-1"></i>Back to List
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-check me-2"></i>Current Allocations
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if allocations %}
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Invoice</th>
                                                <th>Amount</th>
                                                <th>Allocated At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for allocation in allocations %}
                                            <tr>
                                                <td>
                                                    <span class="fw-monospace">{{ allocation.order.invoice_code }}</span>
                                                </td>
                                                <td>
                                                    <span class="fw-bold">{{ allocation.amount }} {{ payment.currency }}</span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">{{ allocation.allocated_at|date:"M d, Y H:i" }}</small>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">No allocations yet</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outstanding Orders Allocation -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-arrow-right-circle me-2"></i>Allocate to Outstanding Orders
                        </h5>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="allocateFullAmounts()">
                                <i class="bi bi-check-all me-1"></i>Allocate Full Outstanding
                            </button>
                            <button type="button" class="btn btn-success btn-sm" onclick="submitAllocations()">
                                <i class="bi bi-check-circle me-1"></i>Allocate Selected
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- CSRF Token -->
                    <form id="csrf-form" style="display:none;">{% csrf_token %}</form>

                    <!-- Filters -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="status-filter" class="form-label fw-semibold">Payment Status</label>
                            <select id="status-filter" class="form-select" onchange="filterOrders()">
                                <option value="">All Statuses</option>
                                <option value="unpaid">Unpaid</option>
                                <option value="partially_paid">Partially Paid</option>
                                <option value="fully_paid">Fully Paid</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search-filter" class="form-label fw-semibold">Search</label>
                            <input type="text" id="search-filter" class="form-control" placeholder="Invoice code..." onkeyup="filterOrders()">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Clear Filters
                            </button>
                        </div>
                    </div>

                    <!-- Orders Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="orders-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Invoice</th>
                                    <th>Date</th>
                                    <th>Total Amount</th>
                                    <th>Paid Amount</th>
                                    <th>Outstanding</th>
                                    <th>Payment Status</th>
                                    <th style="width: 200px;">Allocate Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in outstanding_orders %}
                                <tr class="order-row" data-status="{{ order.payment_status_display|lower|cut:' ' }}" data-invoice="{{ order.invoice_code|lower }}">
                                    <td>
                                        <input type="checkbox" class="order-checkbox" value="{{ order.id }}" onchange="updateAllocationInput({{ order.id }})">
                                    </td>
                                    <td>
                                        <span class="fw-monospace">{{ order.invoice_code }}</span>
                                    </td>
                                    <td>{{ order.date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="fw-bold">{{ order.total_amount }} {{ payment.currency }}</span>
                                    </td>
                                    <td>
                                        <span class="text-success">{{ order.total_paid }} {{ payment.currency }}</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold {% if order.outstanding > 0 %}text-warning{% else %}text-success{% endif %}">
                                            {{ order.outstanding }} {{ payment.currency }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if order.payment_status_display == 'Fully Paid' %}
                                            <span class="badge bg-success">Fully Paid</span>
                                        {% elif order.payment_status_display == 'Partially Paid' %}
                                            <span class="badge bg-warning">Partially Paid</span>
                                        {% else %}
                                            <span class="badge bg-danger">Unpaid</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number"
                                                   class="form-control allocation-input"
                                                   step="0.01"
                                                   min="0"
                                                   max="{{ order.outstanding }}"
                                                   placeholder="0.00"
                                                   data-order-id="{{ order.id }}"
                                                   data-outstanding="{{ order.outstanding }}"
                                                   onchange="validateAllocationAmount(this)">
                                            <span class="input-group-text">{{ payment.currency }}</span>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                            <h5>No outstanding orders found</h5>
                                            <p>All orders for this customer are fully paid</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                        <div class="text-muted small">
                            Selected orders: <span id="selected-count">0</span> |
                            Total allocation: <span id="total-allocation">0.00</span> {{ payment.currency }}
                        </div>
                        <div class="text-muted small">
                            Payment unallocated: <span class="fw-bold">{{ payment.unallocated_amount }} {{ payment.currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedOrders = new Set();
let allocationInputs = {};

// Initialize allocation inputs
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.allocation-input').forEach(input => {
        const orderId = input.getAttribute('data-order-id');
        allocationInputs[orderId] = input;
    });
    updateSummary();
});

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.order-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedOrders.add(parseInt(checkbox.value));
        } else {
            selectedOrders.delete(parseInt(checkbox.value));
        }
    });

    updateSummary();
}

function updateAllocationInput(orderId) {
    const checkbox = document.querySelector(`.order-checkbox[value="${orderId}"]`);
    const input = allocationInputs[orderId];

    if (checkbox.checked) {
        selectedOrders.add(parseInt(orderId));
        // Auto-fill with outstanding amount if input is empty
        if (!input.value || parseFloat(input.value) === 0) {
            input.value = input.getAttribute('data-outstanding');
        }
    } else {
        selectedOrders.delete(parseInt(orderId));
        input.value = '';
    }

    updateSummary();
}

function validateAllocationAmount(input) {
    const amount = parseFloat(input.value) || 0;
    const outstanding = parseFloat(input.getAttribute('data-outstanding'));
    const maxAmount = Math.min(outstanding, {{ payment.unallocated_amount }});

    if (amount > outstanding) {
        input.value = outstanding;
        alert(`Amount cannot exceed outstanding amount (${outstanding})`);
    } else if (amount > maxAmount) {
        input.value = maxAmount;
        alert(`Amount cannot exceed available payment amount (${maxAmount})`);
    }

    updateSummary();
}

function allocateFullAmounts() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => {
        const orderId = checkbox.value;
        const input = allocationInputs[orderId];
        const outstanding = parseFloat(input.getAttribute('data-outstanding'));

        if (outstanding > 0) {
            checkbox.checked = true;
            input.value = outstanding;
            selectedOrders.add(parseInt(orderId));
        }
    });

    updateSummary();
}

function updateSummary() {
    const selectedCount = selectedOrders.size;
    let totalAllocation = 0;

    selectedOrders.forEach(orderId => {
        const input = allocationInputs[orderId];
        if (input && input.value) {
            totalAllocation += parseFloat(input.value) || 0;
        }
    });

    document.getElementById('selected-count').textContent = selectedCount;
    document.getElementById('total-allocation').textContent = totalAllocation.toFixed(2);
}

function filterOrders() {
    const statusFilter = document.getElementById('status-filter').value.toLowerCase();
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    const rows = document.querySelectorAll('.order-row');

    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const invoice = row.getAttribute('data-invoice');
        const statusMatch = !statusFilter || status.includes(statusFilter);
        const searchMatch = !searchFilter || invoice.includes(searchFilter);

        if (statusMatch && searchMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('search-filter').value = '';
    filterOrders();
}

function submitAllocations() {
    if (selectedOrders.size === 0) {
        alert('Please select at least one order to allocate payment to.');
        return;
    }

    const allocations = [];
    let totalAmount = 0;

    selectedOrders.forEach(orderId => {
        const input = allocationInputs[orderId];
        const amount = parseFloat(input.value) || 0;

        if (amount > 0) {
            allocations.push({
                order_id: parseInt(orderId),
                amount: amount
            });
            totalAmount += amount;
        }
    });

    if (allocations.length === 0) {
        alert('Please enter allocation amounts for selected orders.');
        return;
    }

    if (totalAmount > {{ payment.unallocated_amount }}) {
        alert(`Total allocation amount (${totalAmount}) exceeds available payment amount ({{ payment.unallocated_amount }}).`);
        return;
    }

    // Confirm allocation
    if (!confirm(`Allocate ${totalAmount} {{ payment.currency }} to ${allocations.length} order(s)?`)) {
        return;
    }

    // Submit allocation
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "payments:allocate_payment" payment.payment_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ allocations: allocations })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Payment allocated successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Request failed. Please try again.');
    });
}
</script>

<style>
.card {
    border-radius: 16px;
    border: none;
}

.table th {
    font-weight: 600;
    color: var(--text-primary);
    border-top: none;
    padding: 1rem;
}

.table td {
    padding: 1rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
}

.input-group-text {
    background-color: var(--accent-magenta);
    color: white;
    border: 2px solid var(--accent-magenta);
    font-weight: 600;
}

.btn {
    border-radius: 8px;
    font-weight: 600;
}

.breadcrumb {
    background: none;
    padding: 0;
}

.breadcrumb-item a {
    color: var(--accent-magenta);
    text-decoration: none;
}

.breadcrumb-item.active {
    color: var(--text-secondary);
}
</style>
{% endblock %}


