{% extends "base.html" %}
{% block title %}Payment {{ payment.payment_id|truncatechars:8 }} | Zahara ERP{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Payment Details</h5>
        <dl class="row mb-0">
          <dt class="col-sm-4">Customer</dt>
          <dd class="col-sm-8">{{ payment.customer.name }}</dd>
          <dt class="col-sm-4">Amount</dt>
          <dd class="col-sm-8">{{ payment.amount }} {{ payment.currency }}</dd>
          <dt class="col-sm-4">Method</dt>
          <dd class="col-sm-8">{{ payment.get_payment_method_display }}</dd>
          <dt class="col-sm-4">Date</dt>
          <dd class="col-sm-8">{{ payment.payment_date|date:"M d, Y" }}</dd>
          <dt class="col-sm-4">Status</dt>
          <dd class="col-sm-8">{{ payment.get_status_display }}</dd>
          <dt class="col-sm-4">Reference</dt>
          <dd class="col-sm-8">{{ payment.reference_number|default:"-" }}</dd>
          <dt class="col-sm-4">Unallocated</dt>
          <dd class="col-sm-8">{{ payment.unallocated_amount }}</dd>
        </dl>
        <div class="mt-3">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'payments:payment_edit' payment.payment_id %}">Edit</a>
          <a class="btn btn-sm btn-outline-primary" href="{% url 'payments:payment_list' %}">Back to list</a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Allocations</h5>
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Invoice</th><th>Amount</th><th>Allocated At</th>
            </tr>
          </thead>
          <tbody>
            {% for allocation in allocations %}
            <tr>
              <td>{{ allocation.order.invoice_code }}</td>
              <td>{{ allocation.amount }}</td>
              <td>{{ allocation.allocated_at|date:"M d, Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-muted">No allocations</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-body">
    <h5 class="card-title">Allocate to Outstanding Orders</h5>
    <form id="csrf-form" style="display:none;">{% csrf_token %}</form>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Invoice</th><th>Date</th><th>Total</th><th>Outstanding</th><th style="width:220px">Allocate</th>
          </tr>
        </thead>
        <tbody>
          {% for order in outstanding_orders %}
          <tr>
            <td>{{ order.invoice_code }}</td>
            <td>{{ order.date|date:"Y-m-d" }}</td>
            <td>{{ order.total_amount }}</td>
            <td>{{ order.outstanding_amount }}</td>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" class="form-control" step="0.01" min="0" placeholder="Amount" data-order-id="{{ order.id }}">
                <button class="btn btn-primary" type="button" onclick="queueAllocation(this)">Add</button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted">No outstanding orders</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
      <div class="text-muted small">Queued allocations: <span id="queue-count">0</span></div>
      <button class="btn btn-success btn-sm" type="button" onclick="submitAllocations()">Allocate Selected</button>
    </div>
  </div>
</div>

<script>
  const queue = [];
  function queueAllocation(btn) {
    const input = btn.closest('.input-group').querySelector('input');
    const amount = parseFloat(input.value || '0');
    const orderId = parseInt(input.getAttribute('data-order-id'));
    if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }
    queue.push({ order_id: orderId, amount: amount });
    input.value = '';
    document.getElementById('queue-count').textContent = queue.length;
  }

  function submitAllocations() {
    if (queue.length === 0) { alert('No allocations queued'); return; }
    const tokenEl = document.querySelector('#csrf-form input[name="csrfmiddlewaretoken"]');
    const csrftoken = tokenEl ? tokenEl.value : '';
    fetch('{% url "payments:allocate_payment" payment.payment_id %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({ allocations: queue })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.success) { alert(data.error || 'Error'); return; }
      location.reload();
    })
    .catch(err => { console.error(err); alert('Request failed'); });
  }
</script>
{% endblock %}


